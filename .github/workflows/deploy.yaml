name: Deploy Web & Admin to Vercel (manual-selectable)

on:
  workflow_dispatch:
    inputs:
      target:
        description: '배포할 앱 선택'
        required: true
        default: 'all'
        type: choice
        options: [all, web, admin]

jobs:
  # ──────────────────────────── WEB ────────────────────────────
  deploy-web:
    if: github.event.inputs.target == 'all' || github.event.inputs.target == 'web'
    runs-on: ubuntu-latest
    concurrency: web-prod
    env:
      VERCEL_TOKEN:      ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID:     ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_WEB }}
      PROD_ALIAS:        "web.dddorok.vercel.app"
      HEALTH_PATH:       "/health"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: (Optional) Install deps for lint/type-check
        run: pnpm install --frozen-lockfile

      - name: Vercel Deploy (Web – server‐side build)
        id: deploy-web
        run: |
          echo "▶ Deploying apps/web via Vercel server-side build"
          url=$(
            npx vercel deploy apps/web \
              --prod \
              --yes \
              --token $VERCEL_TOKEN
          )
          echo "url=$url" >> $GITHUB_OUTPUT

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Smoke test & auto-rollback (Web)
        run: |
          target="${{ steps.deploy-web.outputs.url }}$HEALTH_PATH"
          echo "Health-check → $target"
          code=$(curl -s -o /dev/null -w "%{http_code}" "$target")
          if [ "$code" != "200" ]; then
            echo "❌ Health-check failed ($code) → rolling back"
            prev=$(curl -s -H "Authorization: Bearer $VERCEL_TOKEN" \
              "https://api.vercel.com/v6/deployments?projectId=$VERCEL_PROJECT_ID&limit=2&state=READY" \
              | jq -r '.deployments[1].uid')
            curl -s -X POST -H "Authorization: Bearer $VERCEL_TOKEN" \
              -H "Content-Type: application/json" \
              "https://api.vercel.com/v2/aliases" \
              -d "{\"deploymentId\":\"$prev\",\"alias\":\"$PROD_ALIAS\"}"
            exit 1
          else
            echo "✅ Health-check OK"
          fi

  # ────────────────────────── ADMIN ────────────────────────────
  deploy-admin:
    if: github.event.inputs.target == 'all' || github.event.inputs.target == 'admin'
    runs-on: ubuntu-latest
    concurrency: admin-prod
    env:
      VERCEL_TOKEN:      ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID:     ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_ADMIN }}
      PROD_ALIAS:        "admin.dddorok.vercel.app"
      HEALTH_PATH:       "/health"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: (Optional) Install deps for lint/type-check
        run: pnpm install --frozen-lockfile

      - name: Vercel Deploy (Admin – server‐side build)
        id: deploy-admin
        run: |
          echo "▶ Deploying apps/admin via Vercel server-side build"
          url=$(
            npx vercel deploy apps/admin \
              --prod \
              --yes \
              --token $VERCEL_TOKEN
          )
          echo "url=$url" >> $GITHUB_OUTPUT

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Smoke test & auto-rollback (Admin)
        run: |
          target="${{ steps.deploy-admin.outputs.url }}$HEALTH_PATH"
          echo "Health-check → $target"
          code=$(curl -s -o /dev/null -w "%{http_code}" "$target")
          if [ "$code" != "200" ]; then
            echo "❌ Health-check failed ($code) → rolling back"
            prev=$(curl -s -H "Authorization: Bearer $VERCEL_TOKEN" \
              "https://api.vercel.com/v6/deployments?projectId=$VERCEL_PROJECT_ID&limit=2&state=READY" \
              | jq -r '.deployments[1].uid')
            curl -s -X POST -H "Authorization: Bearer $VERCEL_TOKEN" \
              -H "Content-Type: application/json" \
              "https://api.vercel.com/v2/aliases" \
              -d "{\"deploymentId\":\"$prev\",\"alias\":\"$PROD_ALIAS\"}"
            exit 1
          else
            echo "✅ Health-check OK"
          fi
