name: Deploy Web & Admin to Vercel (manual-selectable)

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Î∞∞Ìè¨Ìï† Ïï± ÏÑ†ÌÉù'
        required: true
        default: 'all'
        type: choice
        options: [all, web, admin]

jobs:
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ WEB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  deploy-web:
    if: github.event.inputs.target == 'all' || github.event.inputs.target == 'web'
    runs-on: ubuntu-latest
    concurrency: web-prod
    env:
      VERCEL_TOKEN:      ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID:     ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_WEB }}
      PROD_ALIAS:        "web.dddorok.vercel.app"
      HEALTH_PATH:       "/health"

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v3
        with:
          version: 10

      - run: pnpm install --frozen-lockfile

      # (ÏÑ†ÌÉù) ÌòπÏãú ÎÇ®ÏïÑÏûàÎäî .vercel ÏßÄÏö∞Í∏∞
      - name: Clean up old .vercel for Web
        run: rm -rf apps/web/.vercel

      - name: Vercel Pull (Web)
        run: |
          npx vercel pull apps/web \
            --yes \
            --environment=production \
            --token $VERCEL_TOKEN
        # ‚Üí apps/web/.vercel ÏÉùÏÑ±

      - name: Vercel Build (Web)
        run: |
          npx vercel build apps/web \
            --prod \
            --token $VERCEL_TOKEN
        # ‚Üí apps/web/.vercel/output ÏÉùÏÑ±

      - name: DEBUG ‚Äì where is Web output?
        run: |
          echo "üìÇ apps/web/.vercel Ìè¥Îçî:"
          ls -al apps/web/.vercel || true
          echo "üìÇ apps/web/.vercel/output Ìè¥Îçî:"
          ls -al apps/web/.vercel/output || true

      - name: Vercel Deploy (Web)
        id: deploy-web
        run: |
          url=$(npx vercel deploy apps/web/.vercel/output \
            --prebuilt \
            --prod \
            --token $VERCEL_TOKEN)
          echo "url=$url" >> $GITHUB_OUTPUT

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Smoke test & auto-rollback (Web)
        run: |
          target="${{ steps.deploy-web.outputs.url }}$HEALTH_PATH"
          echo "Health-check ‚Üí $target"
          code=$(curl -s -o /dev/null -w "%{http_code}" "$target")
          if [ "$code" != "200" ]; then
            echo "‚ùå Health-check failed ($code) ‚Üí rolling back"
            prev=$(curl -s -H "Authorization: Bearer $VERCEL_TOKEN" \
              "https://api.vercel.com/v6/deployments?projectId=$VERCEL_PROJECT_ID&limit=2&state=READY" \
              | jq -r '.deployments[1].uid')
            curl -s -X POST -H "Authorization: Bearer $VERCEL_TOKEN" \
              -H "Content-Type: application/json" \
              "https://api.vercel.com/v2/aliases" \
              -d "{\"deploymentId\":\"$prev\",\"alias\":\"$PROD_ALIAS\"}"
            exit 1
          else
            echo "‚úÖ Health-check OK"
          fi

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ADMIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  deploy-admin:
    if: github.event.inputs.target == 'all' || github.event.inputs.target == 'admin'
    runs-on: ubuntu-latest
    concurrency: admin-prod
    env:
      VERCEL_TOKEN:      ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID:     ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_ADMIN }}
      PROD_ALIAS:        "admin.dddorok.vercel.app"
      HEALTH_PATH:       "/health"

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v3
        with:
          version: 10

      - run: pnpm install --frozen-lockfile

      - name: Clean up old .vercel for Admin
        run: rm -rf apps/admin/.vercel

      - name: Vercel Pull (Admin)
        run: |
          npx vercel pull apps/admin \
            --yes \
            --environment=production \
            --token $VERCEL_TOKEN
        # ‚Üí apps/admin/.vercel ÏÉùÏÑ±

      - name: Vercel Build (Admin)
        run: |
          npx vercel build apps/admin \
            --prod \
            --token $VERCEL_TOKEN
        # ‚Üí apps/admin/.vercel/output ÏÉùÏÑ±

      - name: DEBUG ‚Äì where is Admin output?
        run: |
          echo "üìÇ apps/admin/.vercel Ìè¥Îçî:"
          ls -al apps/admin/.vercel || true
          echo "üìÇ apps/admin/.vercel/output Ìè¥Îçî:"
          ls -al apps/admin/.vercel/output || true

      - name: Vercel Deploy (Admin)
        id: deploy-admin
        run: |
          url=$(npx vercel deploy apps/admin/.vercel/output \
            --prebuilt \
            --prod \
            --token $VERCEL_TOKEN)
          echo "url=$url" >> $GITHUB_OUTPUT

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Smoke test & auto-rollback (Admin)
        run: |
          target="${{ steps.deploy-admin.outputs.url }}$HEALTH_PATH"
          echo "Health-check ‚Üí $target"
          code=$(curl -s -o /dev/null -w "%{http_code}" "$target")
          if [ "$code" != "200" ]; then
            echo "‚ùå Health-check failed ($code) ‚Üí rolling back"
            prev=$(curl -s -H "Authorization: Bearer $VERCEL_TOKEN" \
              "https://api.vercel.com/v6/deployments?projectId=$VERCEL_PROJECT_ID&limit=2&state=READY" \
              | jq -r '.deployments[1].uid')
            curl -s -X POST -H "Authorization: Bearer $VERCEL_TOKEN" \
              -H "Content-Type: application/json" \
              "https://api.vercel.com/v2/aliases" \
              -d "{\"deploymentId\":\"$prev\",\"alias\":\"$PROD_ALIAS\"}"
            exit 1
          else
            echo "‚úÖ Health-check OK"
          fi
